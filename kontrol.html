<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Yuca Controller</title>
<style>
  :root{--bd:#333}
  body{margin:0;background:#0b0b0b;color:#eee;font-family:system-ui,Segoe UI,Arial}
  .wrap{max-width:520px;margin:0 auto;padding:16px}
  h1{font-size:18px;margin:6px 0 12px 0}
  .row{margin:.7rem 0}
  label{font-size:12px;opacity:.85}
  input[type="range"]{width:100%}
  .card{border:1px solid var(--bd);border-radius:12px;padding:12px;background:#111}
  .flex{display:flex;gap:12px;align-items:center}
  .cap{font-variant:all-small-caps;opacity:.8}
  .pill{display:inline-block;padding:.25rem .5rem;border:1px solid #444;border-radius:999px;font-size:12px}
  button{padding:6px 10px;border:1px solid #444;background:#1a1a1a;color:#eee;border-radius:8px}
  input[type="text"]{flex:1;max-width:220px;background:#0b0b0b;color:#eee;border:1px solid #333;border-radius:8px;padding:6px}
  .muted{opacity:.5;pointer-events:none}
  hr{border:none;border-top:1px solid #222;margin:12px 0;opacity:.45}
</style>
<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-database-compat.js"></script>
</head>
<body>
<div class="wrap">
  <h1>Yuca Controller <span id="roomtag" class="pill">(sin room)</span></h1>

  <div class="card" id="panel">
    <div class="row flex">
      <label class="cap">Room</label>
      <input id="room" placeholder="CASABE1" type="text">
      <button id="connect">Conectar</button>
    </div>

    <div class="row">
      <label>Escala</label>
      <input id="sc" type="range" min="0.30" max="2.00" step="0.01" value="0.90">
      <div><span id="scv">0.90</span></div>
    </div>
    <div class="row">
      <label>Rotación (°)</label>
      <input id="rot" type="range" min="-45" max="45" step="0.1" value="0">
      <div><span id="rotv">0.0</span></div>
    </div>
    <div class="row">
      <label>Opacidad cámara</label>
      <input id="vop" type="range" min="0" max="0.7" step="0.01" value="0.10">
      <div><span id="vopv">0.10</span></div>
    </div>
    <div class="row">
      <label>Umbral textura (LBP)</label>
      <input id="lbp" type="range" min="0.05" max="0.60" step="0.01" value="0.22">
      <div><span id="lbpv">0.22</span></div>
    </div>
    <div class="row">
      <label>Umbral alineación (IoU)</label>
      <input id="iou" type="range" min="0.05" max="0.60" step="0.01" value="0.28">
      <div><span id="iouv">0.28</span></div>
    </div>
    <div class="row">
      <label>Color construcción</label><br>
      <input id="col" type="color" value="#88ccff">
      <span id="colv">#88CCFF</span>
    </div>
    <div class="row">
      <label>Tamaño partícula (px)</label>
      <input id="psz" type="range" min="0.5" max="6.0" step="0.1" value="1.0">
      <div><span id="pszv">1.0</span></div>
    </div>

    <div class="row flex">
      <label class="cap">UI en display</label>
      <input id="hideUi" type="checkbox"> <span> Ocultar panel en el display</span>
    </div>

    <!-- AUDIO REMOTO -->
    <hr>
    <div class="row">
      <label>Volumen audio</label>
      <input id="gain" type="range" min="0" max="1" step="0.01" value="1">
      <div><span id="gainv">1.00</span></div>
    </div>
    <div class="row">
      <label>Reverb (wet)</label>
      <input id="rev" type="range" min="0" max="1" step="0.01" value="0">
      <div><span id="revv">0.00</span></div>
    </div>
    <div class="row">
      <label>Paneo</label>
      <input id="pan" type="range" min="-1" max="1" step="0.01" value="0">
      <div><span id="panv">0.00</span></div>
    </div>
  </div>
</div>

<script>
const $ = s => document.querySelector(s);

// ===== Firebase init =====
const firebaseConfig = {
  apiKey: "AIzaSyBjuVLR5PDrQ6WpRvIt3561fNzabscw-NI",
  authDomain: "yuca-8f746.firebaseapp.com",
  databaseURL: "https://yuca-8f746-default-rtdb.firebaseio.com",
  projectId: "yuca-8f746",
  storageBucket: "yuca-8f746.firebasestorage.app",
  messagingSenderId: "103587360233",
  appId: "1:103587360233:web:5e64f1be508848ee97af78",
  measurementId: "G-4WJT8PF1C8"
};
if (firebase.apps.length === 0) firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let refCtrl = null;
let refAudio = null;
let hydratingCtrl = true;
let hydratingAudio = true;
let sendTimerCtrl = null;
let sendTimerAudio = null;
const SEND_DELAY = 160;

// estado local separados
const ctrlState = {
  sc: 0.90,
  rotDeg: 0,
  vop: 0.10,
  sensLBP: 0.22,
  thrIoU: 0.28,
  color: '#88ccff',
  psz: 1.0,
  hideUi: false
};
const audioState = {
  gain: 1.0,
  rev: 0.0,
  pan: 0.0
};
const dirtyCtrl  = new Set();
const dirtyAudio = new Set();

// enable/disable
function enableControls(on){
  $('#panel').classList.toggle('muted', !on);
  ['sc','rot','vop','lbp','iou','psz','col','hideUi','gain','rev','pan'].forEach(id=>{
    const el = $('#'+id);
    if (el) el.disabled = !on;
  });
}

// room de URL?
const roomFromUrl = new URLSearchParams(location.search).get('room');
if (roomFromUrl) $('#room').value = roomFromUrl.toUpperCase();

function connectRoom(){
  let room = $('#room').value.trim();
  if(!room){ alert('Pon un nombre de room, ej: CASABE1'); return; }
  room = room.toUpperCase();
  $('#room').value = room;
  $('#roomtag').textContent = room;

  refCtrl  = db.ref(`rooms/${room}/ctrl`);
  refAudio = db.ref(`rooms/${room}/audio`);

  enableControls(true);

  // --- leer ctrl
  refCtrl.on('value', snap => {
    const v = snap.val();
    if (!v){ hydratingCtrl = false; return; }

    if (typeof v.sc === 'number'){ ctrlState.sc = v.sc; $('#sc').value = v.sc; $('#scv').textContent = v.sc.toFixed(2); }
    if (typeof v.rotDeg === 'number'){ ctrlState.rotDeg = v.rotDeg; $('#rot').value = v.rotDeg; $('#rotv').textContent = v.rotDeg.toFixed(1); }
    if (typeof v.vop === 'number'){ ctrlState.vop = v.vop; $('#vop').value = v.vop; $('#vopv').textContent = v.vop.toFixed(2); }
    if (typeof v.sensLBP === 'number'){ ctrlState.sensLBP = v.sensLBP; $('#lbp').value = v.sensLBP; $('#lbpv').textContent = v.sensLBP.toFixed(2); }
    if (typeof v.thrIoU === 'number'){ ctrlState.thrIoU = v.thrIoU; $('#iou').value = v.thrIoU; $('#iouv').textContent = v.thrIoU.toFixed(2); }
    if (typeof v.color === 'string'){ ctrlState.color = v.color; $('#col').value = v.color; $('#colv').textContent = v.color.toUpperCase(); }
    if (typeof v.psz === 'number'){ ctrlState.psz = v.psz; $('#psz').value = v.psz; $('#pszv').textContent = v.psz.toFixed(1); }
    if (typeof v.hideUi === 'boolean'){ ctrlState.hideUi = v.hideUi; $('#hideUi').checked = v.hideUi; }

    hydratingCtrl = false;
  });

  // --- leer audio (otra rama)
  refAudio.on('value', snap => {
    const v = snap.val();
    if (!v){ hydratingAudio = false; return; }

    if (typeof v.gain === 'number'){ audioState.gain = v.gain; $('#gain').value = v.gain; $('#gainv').textContent = v.gain.toFixed(2); }
    if (typeof v.rev  === 'number'){ audioState.rev  = v.rev;  $('#rev').value  = v.rev;  $('#revv').textContent  = v.rev.toFixed(2); }
    if (typeof v.pan  === 'number'){ audioState.pan  = v.pan;  $('#pan').value  = v.pan;  $('#panv').textContent  = v.pan.toFixed(2); }

    hydratingAudio = false;
  });
}
$('#connect').addEventListener('click', connectRoom);

// autoconecta si no hay ?room
if (!roomFromUrl) {
  $('#room').value = 'CASABE1';
  connectRoom();
}

// --- envío agrupado ctrl
function scheduleSendCtrl(){
  if (!refCtrl) return;
  if (hydratingCtrl) return;
  clearTimeout(sendTimerCtrl);
  sendTimerCtrl = setTimeout(()=>{
    if (dirtyCtrl.size === 0) return;
    const payload = {};
    dirtyCtrl.forEach(k => payload[k] = ctrlState[k]);
    payload.ts = Date.now();
    refCtrl.update(payload).catch(err=>console.error('[ctrl update]',err));
    dirtyCtrl.clear();
  }, SEND_DELAY);
}
// --- envío agrupado audio
function scheduleSendAudio(){
  if (!refAudio) return;
  if (hydratingAudio) return;
  clearTimeout(sendTimerAudio);
  sendTimerAudio = setTimeout(()=>{
    if (dirtyAudio.size === 0) return;
    const payload = {};
    dirtyAudio.forEach(k => payload[k] = audioState[k]);
    payload.ts = Date.now();
    refAudio.update(payload).catch(err=>console.error('[audio update]',err));
    dirtyAudio.clear();
  }, SEND_DELAY);
}

// listeners de ctrl
function onCtrlRange(id, key, mirror, decimals){
  const el = $('#'+id);
  el.addEventListener('input', e => {
    if (hydratingCtrl) return;
    const v = parseFloat(e.target.value);
    if (Math.abs(ctrlState[key]-v) < 0.005) {
      if (mirror) $(mirror).textContent = v.toFixed(decimals);
      return;
    }
    ctrlState[key] = v;
    if (mirror) $(mirror).textContent = v.toFixed(decimals);
    dirtyCtrl.add(key);
    scheduleSendCtrl();
  });
}
onCtrlRange('sc','sc','#scv',2);
onCtrlRange('rot','rotDeg','#rotv',1);
onCtrlRange('vop','vop','#vopv',2);
onCtrlRange('lbp','sensLBP','#lbpv',2);
onCtrlRange('iou','thrIoU','#iouv',2);
onCtrlRange('psz','psz','#pszv',1);

$('#col').addEventListener('input', e => {
  if (hydratingCtrl) return;
  const v = e.target.value;
  if (ctrlState.color === v) return;
  ctrlState.color = v;
  $('#colv').textContent = v.toUpperCase();
  dirtyCtrl.add('color');
  scheduleSendCtrl();
});
$('#hideUi').addEventListener('change', e => {
  if (hydratingCtrl) return;
  ctrlState.hideUi = e.target.checked;
  dirtyCtrl.add('hideUi');
  scheduleSendCtrl();
});

// listeners de audio (otra rama)
$('#gain').addEventListener('input', e => {
  if (hydratingAudio) return;
  const v = parseFloat(e.target.value);
  audioState.gain = v;
  $('#gainv').textContent = v.toFixed(2);
  dirtyAudio.add('gain');
  scheduleSendAudio();
});
$('#rev').addEventListener('input', e => {
  if (hydratingAudio) return;
  const v = parseFloat(e.target.value);
  audioState.rev = v;
  $('#revv').textContent = v.toFixed(2);
  dirtyAudio.add('rev');
  scheduleSendAudio();
});
$('#pan').addEventListener('input', e => {
  if (hydratingAudio) return;
  const v = parseFloat(e.target.value);
  // un pelín de deadzone
  if (Math.abs(audioState.pan - v) < 0.01){
    $('#panv').textContent = v.toFixed(2);
    return;
  }
  audioState.pan = v;
  $('#panv').textContent = v.toFixed(2);
  dirtyAudio.add('pan');
  scheduleSendAudio();
});

// enter en room
$('#room').addEventListener('keyup', e => {
  if (e.key === 'Enter') connectRoom();
});
</script>
</body>
</html>
